<html>
<head>
    <script type="text/javascript" src="ClientGlobalContext.js.aspx"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <!--<script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!--Jquery translator plugin-->
    <script src="pp_translate.js"></script>
    <script src="pp_signicattranslation.js"></script>
    <script src="pp_notify.js"></script>
    <script src="pp_signicatcrm.js"></script>
    <script src="pp_signicatapi.js"></script>
    <link rel="stylesheet" type="text/css" href="pp_signicat.css">
    <title>Document signing</title>
    <meta charset="utf-8">
</head>
<body>
    <div class="container">
        <div class="row clearfix">
            <!--<div class="col-xs-12 col-sm-12 col-md-8 col-lg-6  column col-sm-offset-0 col-md-offset-2 col-lg-offset-3">-->
            <div class="col-lg-12">
                <form class="form-horizontal">
                    <fieldset>
                        <legend>
                            <img class="img-responsive img-rounded" src="pp_signicatsendlogo.png" />
                        </legend>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label id="lblselectsignmetod" class="col-md-3 control-label" for="selectsignmetod" data-toggle="tooltip" data-placement="top" title="Chose a method for signing the documents.">Signing method</label>
                                    <div class="col-md-4">
                                        <select id="selectsignmetod" name="selectsignmetod" class="form-control">
                                            <option value="1">InkSign</option>
                                            <option value="2">BankID</option>
                                            <option value="3">TUPAS</option>
                                            <option value="4">NemID</option>
                                            <option value="5">SMS/E-mail OTP</option>
                                            <option value="6">Social</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!--<div class="col-sm-4">
                                <label id="lblink" class="col-md-3 control-label" for="radiosInk" data-toggle="tooltip" data-placement="top" title="The signing will include the Ink method in addition.">Ink?</label>
                                <div class="col-md-3" id="radiosInk">
                                    <label id="lblradios-15" class="radio-inline" for="radios-15">
                                        <input type="radio" name="radiosInk" id="radios-15" value="15">
                                        Yes
                                    </label>
                                    <label id="lblradios-16" class="radio-inline" for="radios-16">
                                        <input type="radio" name="radiosInk" id="radios-16" value="16" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-sm-4">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblink" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="The signing will include the Ink method in addition.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosInk" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>InkSign?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="form-group">
                                    <label id="lbldaystolive" class="col-md-3 control-label" for="daystolive" data-toggle="tooltip" data-placement="top" title="How long will the documents be available for signing.">Expiration</label>
                                    <div class="col-md-3">
                                        <input id="daystolive" name="daystolive" type="number" value="60" placeholder="Days" class="form-control input-md">
                                    </div>
                                </div>
                            </div>

                        </div><!--End of row-->

                        <div class="row">

                            <!--<div class="col-sm-4">
                                <label id="lblauth" class="col-md-3 control-label" for="radiosAuth" data-toggle="tooltip" data-placement="top" title="The user will have to authenticate before seeing the document.">Authentication?</label>
                                <div class="col-md-3" id="radiosAuth">
                                    <label id="lblradios-9" class="radio-inline" for="radios-9">
                                        <input type="radio" name="radiosAuth" id="radios-9" value="9">
                                        Yes
                                    </label>
                                    <label id="lblradios-10" class="radio-inline" for="radios-10">
                                        <input type="radio" name="radiosAuth" id="radios-10" value="10" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblauth" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="The user will have to authenticate before seeing the document.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosAuth" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Authentication?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!--<div class="col-sm-4">
                                <label id="lblsendsms" class="col-md-3 control-label" for="radiosSMS" data-toggle="tooltip" data-placement="top" title="Send the link for signing in SMS to the reciever.">Send SMS?</label>
                                <div class="col-md-3" id="radiosSMS">
                                    <label id="lblradios-13" class="radio-inline" for="radios-13">
                                        <input type="radio" name="radiosSMS" id="radios-13" value="13">
                                        Yes
                                    </label>
                                    <label id="lblradios-14" class="radio-inline" for="radios-14">
                                        <input type="radio" name="radiosSMS" id="radios-14" value="14" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblsendsms" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Send the link for signing in SMS to the reciever.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosSMS" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Send SMS?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!--<div class="col-sm-4">
                                <label id="lblnotify" class="col-md-3 control-label" for="radiosNotify" data-toggle="tooltip" data-placement="top" title="An email will be sent to you when a document is signed.">Notification?</label>
                                <div class="col-md-3" id="radiosNotify">
                                    <label id="lblradios-0" class="radio-inline" for="radios-0">
                                        <input type="radio" name="radiosNotify" id="radios-0" value="1">
                                        Yes
                                    </label>
                                    <label id="lblradios-1" class="radio-inline" for="radios-1">
                                        <input type="radio" name="radiosNotify" id="radios-1" value="2" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblnotify" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="An email will be sent to you when a document is signed.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosNotify" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Notification?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                        </div> <!--End of row-->

                        <div class="row">

                            <!--<div class="col-sm-4">
                                <label id="lblsaveorg" class="col-md-3 control-label" for="radiosSaveOrg" data-toggle="tooltip" data-placement="top" title="The uploaded documents will be saved in CRM notes.">Save original?</label>
                                <div class="col-md-3" id="radiosSaveOrg">
                                    <label id="lblradios-2" class="radio-inline" for="radios-2">
                                        <input type="radio" name="radiosSaveOrg" id="radios-2" value="3">
                                        Yes
                                    </label>
                                    <label id="lblradios-3" class="radio-inline" for="radios-3">
                                        <input type="radio" name="radiosSaveOrg" id="radios-3" value="4" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblsaveorg" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="The uploaded documents will be saved in CRM notes.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosSaveOrg" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Save original?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!--<div class="col-sm-4">
                                <label id="lblsendcopy" class="col-md-3 control-label" for="radiosSendCopy" data-toggle="tooltip" data-placement="top" title="The signed documents will be sent as a copy to the signatories.">Send copy?</label>
                                <div class="col-md-3" id="radiosSendCopy">
                                    <label id="lblradios-11" class="radio-inline" for="radios-11">
                                        <input type="radio" name="radiosSendCopy" id="radios-11" value="11">
                                        Yes
                                    </label>
                                    <label id="lblradios-12" class="radio-inline" for="radios-12">
                                        <input type="radio" name="radiosSendCopy" id="radios-12" value="12" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblsendcopy" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="The signed documents will be sent as a copy to the signatories.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosSendCopy" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Send copy?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!--<div class="col-sm-4">
                                <label id="lblsaveinsp" class="col-md-3 control-label" for="radiosSaveInSP" data-toggle="tooltip" data-placement="top" title="The signed documents will be saved in the Sharepoint Document Location of the parent record.">Save in Sharepoint?</label>
                                <div class="col-md-3" id="radiosSaveInSP">
                                    <label id="lblradios-4" class="radio-inline" for="radios-4">
                                        <input type="radio" name="radiosSaveInSP" id="radios-4" value="5">
                                        Yes
                                    </label>
                                    <label id="lblradios-5" class="radio-inline" for="radios-5">
                                        <input type="radio" name="radiosSaveInSP" id="radios-5" value="6" checked="checked">
                                        No
                                    </label>
                                </div>
                            </div>-->

                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblsaveinsp" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="The signed documents will be saved in the Sharepoint Document Location of the parent record.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosSaveInSP" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Save in Sharepoint?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                        </div> <!--End of row-->
                        <!--Email-->
                        <div class="form-group">
                            <label id="lblsubject" class="col-md-3 control-label" for="subject">Subject</label>
                            <div class="col-md-9">
                                <input id="subject" name="subject" type="text" placeholder="Email header" class="form-control input-md">
                            </div>
                            <!--<label class="col-md-3 control-label" for="email">Avsender</label>
                            <div class="col-md-3">
                                <input id="email" name="email" type="text" placeholder="example@mail.com" class="form-control input-md">
                            </div>-->
                        </div>
                        <!-- Textarea -->
                        <div class="form-group">
                            <label id="lblmessage" class="col-md-3 control-label" for="message">Message</label>
                            <div class="col-md-9">
                                <textarea class="form-control" id="message" name="message" placeholder="Email message"></textarea>
                            </div>
                        </div>
                        <!--File upload local-->
                        <div class="form-group">
                            <label id="lblselectfiles" class="col-md-3 control-label" for="filetosend" data-toggle="tooltip" data-placement="top" title="Chose a file from your local computer.">Select file(s)</label>
                            <div class="col-md-9">
                                <input type="file" accept="application/pdf" class="form-control-file" id="filetosend" multiple data-toggle="tooltip" data-placement="top" title="Chose a file from your local computer.">
                                <small id="fileHelp" class="form-text text-muted">Plase attach file(s) you want to send for signing.</small>
                                <div id="filenames"></div>
                            </div>
                        </div>

                        <!--Recipients-->
                        <!--<hr />-->
                        <div class="form-group" id="saveonlymergedDiv" hidden>
                            <!--<label id="lblsavemerged" class="col-md-3 control-label" for="radiosSaveMerged" data-toggle="tooltip" data-placement="top" title="If NO, then all the signed documents inclusive the merged ones will be saved in CRM notes.">Save only merged?</label>
                            <div class="col-md-3" id="radiosSaveMerged">
                                <label id="lblradios-6" class="radio-inline" for="radios-6">
                                    <input type="radio" name="radiosSaveMerged" id="radios-6" value="7" checked="checked">
                                    Yes
                                </label>
                                <label id="lblradios-7" class="radio-inline" for="radios-7">
                                    <input type="radio" name="radiosSaveMerged" id="radios-7" value="8">
                                    No
                                </label>
                            </div>-->
                            <div class="items col-xs-4 col-sm-4 col-md-2 col-lg-2">
                                <div class="info-block block-info clearfix">
                                    <div data-toggle="buttons" class="btn-group bizmoduleselect">
                                        <label id="lblsavemerged" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="If NO, then all the signed documents inclusive the merged ones will be saved in CRM notes.">
                                            <div class="bizcontent">
                                                <input type="checkbox" id="radiosSaveMerged" autocomplete="off" value="">
                                                <span class="glyphicon glyphicon-ok glyphicon-lg"></span>
                                                <h5>Save only merged?</h5>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="lblrecipeints" class="col-md-3 control-label" for="search" data-toggle="tooltip" data-placement="top" title="These contacts will receive an email for signing the documents.">Recipients</label>
                            <div class="col-md-9">
                                <div class="input-group">
                                    <div class="input-group-btn">
                                        <button type="button" class="btn btn-search btn-default dropdown-toggle" data-toggle="dropdown">
                                            <span class="glyphicon glyphicon-search"></span>
                                            <span id="spansearch" class="label-icon">Search</span>
                                            <span class="caret"></span>
                                        </button>
                                        <ul id="searchMenu" class="dropdown-menu pull-left" role="menu">
                                            <li id="accountli">
                                                <a id="account" href="#">
                                                    <span class="glyphicon glyphicon-book"></span>
                                                    <span id="spanaccounts" class="label-icon">Accounts</span>
                                                </a>
                                            </li>
                                            <li id="contactli" class="ui-se">
                                                <a id="contact" href="#">
                                                    <span class="glyphicon glyphicon-user"></span>
                                                    <span id="spancontacts" class="label-icon">Contacts</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <input id="search" name="search" type="text" class="form-control autocomplete" placeholder="Search in contacts or accounts...">
                                    <input id="contactInfo" name="contactInfo" hidden type="text">
                                </div>
                            </div>
                        </div>
                        <br />
                        <br />

                        <table id="recipients" class="table table-bordered table-inverse">
                            <thead>
                                <tr class="info">
                                    <th></th>
                                    <th>Type</th>
                                    <th id="thname">Name</th>
                                    <th id="thcompany">Company</th>
                                    <th id="themail">Email</th>
                                    <th id="thmobile">Mobile</th>
                                    <th><span class="glyphicon glyphicon-trash"></span></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <!-- Button (Double) -->
                        <div class="form-group">
                            <label class="col-md-3 control-label" for="btnSubmit"></label>
                            <div class="col-md-8">
                                <button id="submit" type="submit" name="btnSubmit" class="btn btn-primary">Send</button>
                                <button id="btnCancel" name="cancel" class="btn btn-danger">Cancel</button>
                                <img src="pp_loading.gif" id="loading-indicator" style="display:none" />
                                <button id="btnDone" name="done" class="btn btn-success">Done</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
    <div id="footer">
        <div class="container">
            <!--<p class="text-muted credit">Ta kontakt med <a href="http://www.prosesspilotene.no">Prosesspilotene</a>.</p>-->
        </div>
    </div>
</body>
</html>

<script>

    $("form").submit(function (e) {
        e.preventDefault();
    });

    $(function () {

        $('#radiosSaveMerged').prop('checked', true);
        $('#lblsavemerged').addClass('active');

        var obj = getDataParam();
        var entityid = obj.entityid;
        var lcid = obj.lcid;
        var docLocExists = CheckDocLocation(entityid);

        HandleTranslation(lcid);

        if (!docLocExists) {
            $('#lblsaveinsp').click(false);
            $.notify($.translate.get_text('doclocnotify'), "warn",
                { clickToHide: true, autoHide: true, position: "top" });
        }

        var configValues = GetSignicatConfig();

        if (configValues != null) {
            var isDisabled = $("#radios-4").is(':disabled');

            if (!configValues.pp_method1)
                $("#selectsignmetod option[value='1']").remove();
            if (!configValues.pp_method2)
                $("#selectsignmetod option[value='2']").remove();
            if (!configValues.pp_method3)
                $("#selectsignmetod option[value='3']").remove();
            if (!configValues.pp_method4)
                $("#selectsignmetod option[value='4']").remove();
            if (!configValues.pp_method5)
                $("#selectsignmetod option[value='5']").remove();
            if (!configValues.pp_method6)
                $("#selectsignmetod option[value='6']").remove();

            if (configValues.pp_isink == 1) { //Ink
                //$('input:radio[name="radiosInk"][value="15"]').prop('checked', true);
                //$('input:radio[name="radiosInk"][value="16"]').prop('checked', false);

                $('#radiosInk').prop('checked', true);
                $('#lblink').addClass('active');
            }

            if (configValues.pp_authentication == 1) { //Auth
                //$('input:radio[name="radiosAuth"][value="9"]').prop('checked', true);
                //$('input:radio[name="radiosAuth"][value="10"]').prop('checked', false);

                $('#radiosAuth').prop('checked', true);
                $('#lblauth').addClass('active');
            }

            $("#daystolive").val(configValues.pp_daystolive);

            if (configValues.pp_sendsms == true) { //SendSMS
                //$('input:radio[name="radiosSMS"][value="13"]').prop('checked', true);
                //$('input:radio[name="radiosSMS"][value="14"]').prop('checked', false);

                $('#radiosSMS').prop('checked', true);
                $('#lblsendsms').addClass('active');
            }

            if (configValues.pp_notify == true) { //Notify
                //$('input:radio[name="radiosNotify"][value="1"]').prop('checked', true);
                //$('input:radio[name="radiosNotify"][value="2"]').prop('checked', false);

                $('#radiosNotify').prop('checked', true);
                $('#lblnotify').addClass('active');
            }

            if (configValues.pp_saveoriginal == true) { //Save Original
                //$('input:radio[name="radiosSaveOrg"][value="3"]').prop('checked', true);
                //$('input:radio[name="radiosSaveOrg"][value="4"]').prop('checked', false);

                $('#radiosSaveOrg').prop('checked', true);
                $('#lblsaveorg').addClass('active');
            }

            if (configValues.pp_sendcopy == true) { //SendCopy
                //$('input:radio[name="radiosSendCopy"][value="11"]').prop('checked', true);
                //$('input:radio[name="radiosSendCopy"][value="12"]').prop('checked', false);

                $('#radiosSendCopy').prop('checked', true);
                $('#lblsendcopy').addClass('active');
            }

            if (configValues.pp_saveinsp == true && !isDisabled) { //Save in SP
                //$('input:radio[name="radiosSaveInSP"][value="5"]').prop('checked', true);
                //$('input:radio[name="radiosSaveInSP"][value="6"]').prop('checked', false);

                $('#radiosSaveInSP').prop('checked', true);
                $('#lblsaveinsp').addClass('active');
            }

            if (configValues.pp_disable == true) { //Disable all controls
                //$('#selectsignmetod').prop('disabled', true);
                $('#lblink').click(false);
                $('#lblauth').click(false);
                $("#daystolive").prop('disabled', true);
                $('#lblsendsms').click(false);
                $('#lblnotify').click(false);
                $('#lblsaveorg').click(false);
                $('#lblsendcopy').click(false);
                $('#lblsaveinsp').click(false);
                $('#lblsavemerged').click(false);
                $('.input-group-btn').click(false);
            }

            if (configValues.pp_searchin != null) {
                if (configValues.pp_searchin.Value == 1)
                    searchIn = "account";
                if (configValues.pp_searchin.Value == 2)
                    searchIn = "contact";
            }
        }

        //$('[data-toggle="tooltip"]').tooltip();
        $('#btnDone').hide();

        $(window).keydown(function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                return false;
            }
        });
    });

    var searchIn = null;
    $('.input-group-btn .dropdown-menu li a').click(function () {
        var selText = $(this).html();
        $(this).parents('.input-group-btn').find('.btn-search').html(selText);

        searchIn = null;
        var selectedLi = $(this).attr('id');
        searchIn = selectedLi;
        $('html, body').scrollTop($(document).height());
    });

    $('table').on('click', 'tr a#delete', function (e) {
        e.preventDefault();
        $(this).closest('tr').remove();

        var rowCount = $('#recipients tr').length;
        if (rowCount <= 2)
            $("#saveonlymergedDiv").hide();
    });

    $("input[type=file]").change(function () {
        $("#filenames").empty();
        var files = $(this).prop("files");
        var names = $.map(files, function (val) { return val.name; });
        if (names.length == 1)
            return;

        $.each(names, function (index, name) {
            $("#filenames").append(" - " + name);
        });
    });

    $('#search').bind("enterKey", function (e) {
        AddContact();
    });

    $('#search').keyup(function (e) {
        if (e.keyCode == 13) {
            AddContact();
        }
    });

    $('#search').keyup(function (e) { if (e.keyCode == 8) $('#search').val(''); });

    $('#search').click(function () {
        var obj = getDataParam();
        var serverUrl = obj.serverurl;
        var ODATA_ENDPOINT = "/XRMServices/2011/OrganizationData.svc";
        var url = serverUrl + ODATA_ENDPOINT;

        if (searchIn == null) {
            $("#search").notify($.translate.get_text('searchnotify'), "warning", { clickToHide: true, autoHide: true, position: "top" });
            return;
        }

        if (searchIn == "contact")
            $('#search').autocomplete({
                minLength: 3,
                delay: 500,
                autoFocus: true,
                async: false,
                source: function (request, response) {
                    $.ajax({
                        type: "GET",
                        url: url + "/ContactSet?$select=ParentCustomerId,ContactId,EMailAddress1,FullName,MobilePhone&$filter=substringof('"
                            + $("#search").val() + "',EMailAddress1) or  substringof('" + $("#search").val() + "',FullName) or  substringof('"
                            + $("#search").val() + "',FirstName) or  substringof('" + $("#search").val() + "',LastName) or  substringof('"
                            + $("#search").val() + "',MobilePhone)&$top=50&$orderby=FullName asc",
                        datatype: "json",
                        // jsonp will allow you to make cross domain calls
                        beforeSend: function (XMLHttpRequest) {
                            XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        },
                        async: true,
                        success: function (data) {
                            var results = data.d.results;

                            var objArr = [];
                            $.each(results, function (key, item) {
                                var value = searchIn + "&" + item.ContactId + "&" + item.EMailAddress1 + "&" + item.ParentCustomerId.Name + "&" + item.MobilePhone;

                                var labelValue = item.FullName;
                                if (item.ParentCustomerId.Name != null)
                                    labelValue += " - " + item.ParentCustomerId.Name;
                                if (item.EMailAddress1 != null)
                                    labelValue += " - " + item.EMailAddress1;
                                if (item.MobilePhone != null)
                                    labelValue += " - " + item.MobilePhone;

                                var obj = {};
                                obj.value = value;
                                obj.label = labelValue;
                                objArr.push(obj);
                            });

                            response($.map(objArr, function (item) {
                                return {
                                    label: item.label,
                                    value: item.value
                                };
                            }));
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            $.notify($.translate.get_text('noresultnotify') + textStatus, "error");
                        }
                    });
                },
                select: function (event, ui) {
                    if (ui != null && ui.item != null) {
                        event.preventDefault();
                        var label = ui.item.label;
                        $("#search").val(label);
                        $("#contactInfo").val(ui.item.value);
                        return false;
                    }
                },
                focus: function (event, ui) {
                    event.preventDefault();
                    $("#search").val(ui.item.label);
                }
            });

        else if (searchIn == "account")
            $('#search').autocomplete({
                minLength: 3,
                delay: 500,
                autoFocus: true,
                async: false,
                source: function (request, response) {
                    $.ajax({
                        type: "GET",
                        url: url + "/AccountSet?$select=AccountId,EMailAddress1,Name,ParentAccountId,Telephone1&$filter=substringof('"
                            + $("#search").val() + "',EMailAddress1) or  substringof('" + $("#search").val()
                            + "',Name) or substringof('" + $("#search").val() + "',Telephone1)&$top=50&$orderby=Name asc",
                        datatype: "json",
                        // jsonp will allow you to make cross domain calls
                        beforeSend: function (XMLHttpRequest) {
                            XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        },
                        async: true,
                        success: function (data) {
                            var results = data.d.results;

                            var objArr = [];
                            $.each(results, function (key, item) {
                                var value = searchIn + "&" + item.AccountId + "&" + item.EMailAddress1 + "&" + item.ParentAccountId.Name + "&" + item.Telephone1;

                                var labelValue = item.Name;
                                if (item.ParentAccountId.Name != null)
                                    labelValue += " - " + item.ParentAccountId.Name;
                                if (item.EMailAddress1 != null)
                                    labelValue += " - " + item.EMailAddress1;
                                if (item.Telephone1 != null)
                                    labelValue += " - " + item.Telephone1;

                                var obj = {};
                                obj.value = value;
                                obj.label = labelValue;
                                objArr.push(obj);
                            });

                            response($.map(objArr, function (item) {
                                return {
                                    label: item.label,
                                    value: item.value
                                };
                            }));
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            $.notify($.translate.get_text('noresultnotify') + textStatus, "error");
                        }
                    });
                },
                select: function (event, ui) {
                    if (ui != null && ui.item != null) {
                        event.preventDefault();
                        var label = ui.item.label;
                        $("#search").val(label);
                        $("#contactInfo").val(ui.item.value);
                        return false;
                    }
                },
                focus: function (event, ui) {
                    event.preventDefault();
                    $("#search").val(ui.item.label);
                }
            });
    });

    function AddContact() {
        var contactinfo = $("#contactInfo").val();
        var fullname = $("#search").val();
        fullname = fullname.split('-').shift();

        var rowCount = $('#recipients tr').length;
        var values = contactinfo.split('&');
        var entitylogicalname = values[0];
        var customerid = values[1];
        var email = values[2];
        var parentaccountname = (values[3] != 'null') ? values[3] : "";
        var mobile = (values[4] != 'null') ? values[4] : "";

        if (customerid == '') {
            $("#search").notify($.translate.get_text('emptycustomernotify'), "warning", { clickToHide: true, autoHide: true, position: "top" });
            return;
        }

        if (email == 'null') {
            $("#search").notify($.translate.get_text('emptyemailnotify'), "warning", { clickToHide: true, autoHide: true, position: "buttom" });
            return;
        }

        var hit = false;
        $("#recipients").find("tr").each(function () {
            if (email.IsNullOrUndefined) {
                $("#search").notify($.translate.get_text('noresultnotify'), "warning", { clickToHide: true, autoHide: true, position: "buttom" });
                hit = true;
                return false;
            }


            if ($(this).find(".email").html() == email) {
                $("#search").notify($.translate.get_text('customeraddednotify'), "warning", { clickToHide: true, autoHide: true, position: "buttom" });
                hit = true;
                return false;
            }
        });

        if (hit)
            return;

        $("#recipients tbody").append(
            '<tr id="' + customerid + '"><th scope="row">' + rowCount + '</th><td class="type">' +
            entitylogicalname + '</td><td>' + fullname + '</td><td>' + parentaccountname
            + '</td><td class="email">' + email + '</td><td class="mobile">' + mobile +
            '</td><td><a class="btn btn-default" role="button" id="delete"><span class="glyphicon glyphicon-trash"></span></a></td></tr>');
        $('#search').val('');

        var rowCount = $('#recipients tr').length;
        if (rowCount > 2)
            $("#saveonlymergedDiv").show();

    }

    $("#submit").click(function (e) {
        $('#loading-indicator').show();
        $('#submit').attr("disabled", true);

        if ($("#subject").val() === '') {
            $('#submit').attr("disabled", false);
            $("#subject").notify($.translate.get_text('emptysubjectnotify'), "warning");
            $('#loading-indicator').hide();
            return;
        }

        if ($("#message").val() === '') {
            $('#submit').attr("disabled", false);
            $("#message").notify($.translate.get_text('emptymessagenotify'), "warning");
            $('#loading-indicator').hide();
            return;
        }

        var obj = getDataParam();
        var entityname = obj.entityname;
        var entityid = obj.entityid;
        var serverUrl = obj.serverurl;
        var userId = obj.userid;
        var orgname = obj.orgname;
        var lcid = obj.lcid;

        var data = new FormData();
        var files = $("#filetosend").get(0).files;
        var signingmetod = $("#selectsignmetod").val();

        var daystolive = $("#daystolive").val();
        var saveoriginalfile;
        var saveinsp;
        var saveonlymerged;
        var notify;
        var sendsms;
        var auth;
        var isink;
        var sendcopy;
        var allowedFileTypes = ["application/pdf"];

        // Add the uploaded image content to the form data collection
        if (files.length > 0) {
            for (var x = 0; x < files.length; x++) {
                if (allowedFileTypes.indexOf(files[x].type) === -1) {
                    $('#submit').attr("disabled", false);
                    $('#filetosend').notify($.translate.get_text('onlypdfnotify'), "warning");
                    $('#loading-indicator').hide();
                    return;
                }
                data.append("file" + x, files[x]);
            }

            data.append("SigningMetod", signingmetod);
            data.append("Daystolive", daystolive);
            data.append("CustomerOrg", orgname);
            data.append("lcid", lcid);

            var message = $("#message").val();
            data.append("SMSText", message);


            var contactEmail = [];
            var contactMobile = [];
            var customers = [];

            $("#recipients").find("tr").each(function () {
                var obj = {};
                obj.id = this.id;
                obj.entityLogicalName = $(this).find(".type").html();
                customers.push(obj);
            });
            $("#recipients").find("tr").each(function () {
                contactEmail.push($(this).find(".email").html());
                contactMobile.push($(this).find(".mobile").html());
            });

            customers.shift();
            contactEmail.shift();
            contactMobile.shift();

            if (customers.length === 0) {
                $('#submit').attr("disabled", false);
                $("#recipients").notify('addrecipientsnotify', "warning");
                $('#loading-indicator').hide();
                return;
            }

            var senderEmail = GetUserMail(userId);

            //var radiosNotify = $("#radiosNotify input[type='radio']:checked").val();
            //var radiosSaveOrg = $("#radiosSaveOrg input[type='radio']:checked").val();
            //var radiosSaveInSP = $("#radiosSaveInSP input[type='radio']:checked").val();
            //var radiosSaveMerged = $("#radiosSaveMerged input[type='radio']:checked").val();
            //var radiosAuth = $("#radiosAuth input[type='radio']:checked").val();
            //var radiosSendCopy = $("#radiosSendCopy input[type='radio']:checked").val();
            //var radiosSMS = $("#radiosSMS input[type='radio']:checked").val();
            //var radiosInk = $("#radiosInk input[type='radio']:checked").val();


            var authmetod;
            //if (radiosAuth == 9) {
            if ($("#radiosAuth").is(':checked')) {
                auth = true;
                if (signingmetod == 2) //BankID
                    authmetod = 2;
                if (signingmetod == 3)//TUPAS
                    authmetod = 3;
                if (signingmetod == 4)//NEMID
                    authmetod = 4;
                if (signingmetod == 5)//Sms/E-mail
                    authmetod = 5;
                if (signingmetod == 6)//Social
                    authmetod = 6;
            }
                //else if (radiosAuth == 10) {
            else {
                auth = false;
                authmetod = 0;
            }

            //if (radiosSendCopy == 11)
            if ($("#radiosSendCopy").is(':checked'))
                sendcopy = true;
                //else if (radiosSendCopy == 12)
            else
                sendcopy = false;

            data.append("Authmetod", authmetod);

            //if (radiosInk == 15) {
            if ($("#radiosInk").is(':checked')) {
                isink = true;
                data.append("Ink", true);
            }
                //else if (radiosInk == 16) {
            else {
                isink = false;
                data.append("Ink", false);
            }

            //if (radiosNotify == 1) {
            if ($("#radiosNotify").is(':checked')) {
                data.append("NotifyMe", true);
                notify = true;
            }
                //else if (radiosNotify == 2) {
            else {
                data.append("NotifyMe", false);
                notify = false;
            }

            //if (radiosSaveOrg == 3)
            if ($("#radiosSaveOrg").is(':checked'))
                saveoriginalfile = true;
                //else if (radiosSaveOrg == 4)
            else
                saveoriginalfile = false;

            //if (radiosSaveInSP == 5)
            if ($("#radiosSaveInSP").is(':checked'))
                saveinsp = true;
                //else if (radiosSaveInSP == 6)
            else
                saveinsp = false;

            //if (radiosSaveMerged == 7)
            if ($("#radiosSaveMerged").is(':checked'))
                saveonlymerged = true;
                //else if (radiosSaveMerged == 8)
            else
                saveonlymerged = false;

            //if (radiosSMS == 13) {
            if ($("#radiosSMS").is(':checked')) {
                sendsms = true;
                data.append("SendSMS", true);
            }
                //else if (radiosSMS == 14) {
            else {
                sendsms = false;
                data.append("SendSMS", false);
            }


            data.append("SenderEmail", senderEmail);
            data.append("RecipientEmails", contactEmail);
            data.append("RecipientMobiles", contactMobile);
            var apiurl = GetConfigValue("pp_webapiurl");

            $.ajax({
                type: "POST",
                //async: true,
                url: apiurl + "api/SignRequest/PostCRM",
                contentType: false,
                processData: false,
                data: data,
                success: function (sdsurls) {

                    createRecord(sdsurls, "pp_documentsigningSet", files, customers,
                        saveoriginalfile, saveinsp, saveonlymerged, auth, sendsms,
                        notify, isink, sendcopy);

                    //$.notify($.translate.get_text('requestsentnotify'), "success");
                    $('#loading-indicator').hide();
                    $('#btnCancel').hide();
                    $('#submit').hide();
                    $('#btnDone').show();

                },
                error: function (request, status, error) {
                    $.notify($.translate.get_text('errorconnnotify') + ". Error: " + error, "error");
                    $('#loading-indicator').hide();
                    $('#submit').attr("disabled", false);
                }
            });
        }

        if (files.length == 0) {
            $('#submit').attr("disabled", false);
            $('#filetosend').notify($.translate.get_text('nofilenotify'), "warning");
            $('#loading-indicator').hide();
        }
    });

    $("#btnCancel").click(function () {
        closeWindow();
    });

    $("#btnDone").click(function () {
        closeWindow();
    });
</script>